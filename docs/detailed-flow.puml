@startuml
!theme plain
title GCP Cost Agent - Detailed Cost Analysis Flow

actor User
participant "Web Browser" as Browser
participant "FastAPI Backend" as API
participant "LLM (Gemini)" as LLM
participant "MCP Toolbox" as Toolbox
participant "BigQuery" as BQ
database "Billing Export Table" as BillingTable

== Cost Analysis Request ==

User -> Browser: Ask cost question
Browser -> API: POST /chat

API -> API: Validate request
API -> API: Check GCP keywords
API -> LLM: Parse intent with context

LLM -> API: Structured response with intent
API -> API: Log conversation history

alt Intent: costs
  API -> Toolbox: Call get_service_comparison
  
  Toolbox -> Toolbox: Generate SQL query
  Toolbox -> BQ: Execute query for service costs
  
  BQ -> BillingTable: Read billing data
  BillingTable -> BQ: Return records
  BQ -> Toolbox: Query results
  
  Toolbox -> API: Formatted response with services data
  
  API -> API: Process and format data
  API -> Browser: Response with answer and data
  
else Intent: trends
  API -> Toolbox: Call get_cost_trends
  
  Toolbox -> BQ: Execute trend analysis query
  BQ -> Toolbox: Monthly cost data
  Toolbox -> API: Trend analysis results
  API -> API: Generate insights
  API -> Browser: Trend visualization data
  
else Intent: comparison
  API -> API: Extract comparison parameters
  API -> Toolbox: Call comparison tools
  Toolbox -> BQ: Execute comparison queries
  BQ -> Toolbox: Comparative data
  Toolbox -> API: Comparison results
  API -> Browser: Comparison analysis
  
else Intent: optimization
  API -> Toolbox: Call optimization tools
  Toolbox -> BQ: Analyze unused resources
  BQ -> Toolbox: Resource utilization data
  Toolbox -> API: Optimization recommendations
  API -> Browser: Cost optimization suggestions
  
else Intent: unknown
  API -> Browser: Error message
end

Browser -> User: Display results

== Session Management ==

note over API: Maintain conversation context
API -> API: Store in session history

== Error Handling ==

alt Toolbox Connection Error
  Toolbox -> API: Connection failed
  API -> Browser: Toolbox connection error
  Browser -> User: Error notification
end

alt BigQuery Error
  BQ -> Toolbox: Query failed
  Toolbox -> API: No data available
  API -> Browser: No billing data found
  Browser -> User: Informative error
end

@enduml